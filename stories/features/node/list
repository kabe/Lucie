Story: list nodes with node command
  As a cluster administrator
  I want to get a node list using node command
  So that I can get an overview of Lucie clients


  Scenario: node list success (0 node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet

    When I run './node list'

    Then the output should include 'No node is added yet.'


  Scenario: node list success (1 enabled node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE' is added
    And node 'TEST_NODE' is enabled with installer 'TEST_INSTALLER'

    When I run './node list'

    Then the output should include 'ready TEST_NODE (installer = TEST_INSTALLER)'


  Scenario: node list success (1 disabled node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE' is added
    And node 'TEST_NODE' is enabled with installer 'TEST_INSTALLER'
    And node 'TEST_NODE' is disabled

    When I run './node list'

    Then the output should include 'TEST_NODE (installer = TEST_INSTALLER)'


  Scenario: node list success (1 installed node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE' is added
    And node 'TEST_NODE' is enabled with installer 'TEST_INSTALLER'
    And node 'TEST_NODE' succeeded to install

    When I run './node list'

    Then the output should include 'success TEST_NODE (installer = TEST_INSTALLER)'


  Scenario: node list success (1 failed node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE' is added
    And node 'TEST_NODE' is enabled with installer 'TEST_INSTALLER'
    And node 'TEST_NODE' failed to install

    When I run './node list'

    Then the output should include 'fail TEST_NODE (installer = TEST_INSTALLER)'


  Scenario: node list success (1 incomplete node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE' is added
    And node 'TEST_NODE' is enabled with installer 'TEST_INSTALLER'
    And node 'TEST_NODE' is incomplete

    When I run './node list'

    Then the output should include 'incomplete TEST_NODE (installer = TEST_INSTALLER)'


  #------------------------------------------------------------------------------
  # Test all the combinations of two enabled/disabled/installed/failed nodes.
  #------------------------------------------------------------------------------


  Scenario: node list success (2 enabled nodes)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE1' is added
    And node 'TEST_NODE2' is added
    And node 'TEST_NODE1' is enabled with installer 'TEST_INSTALLER1'
    And node 'TEST_NODE2' is enabled with installer 'TEST_INSTALLER2'

    When I run './node list'

    Then the output should include 'ready TEST_NODE1 (installer = TEST_INSTALLER1)'
    And  the output should include 'ready TEST_NODE2 (installer = TEST_INSTALLER2)'


  Scenario: node list success (1 enabled node, 1 disabled node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE1' is added
    And node 'TEST_NODE2' is added
    And node 'TEST_NODE1' is enabled with installer 'TEST_INSTALLER1'
    And node 'TEST_NODE2' is enabled with installer 'TEST_INSTALLER2'
    And node 'TEST_NODE2' is disabled

    When I run './node list'

    Then the output should include 'ready TEST_NODE1 (installer = TEST_INSTALLER1)'
    And  the output should include 'TEST_NODE2 (installer = TEST_INSTALLER2)'


  Scenario: node list success (1 enabled node, 1 installed node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE1' is added
    And node 'TEST_NODE2' is added
    And node 'TEST_NODE1' is enabled with installer 'TEST_INSTALLER1'
    And node 'TEST_NODE2' is enabled with installer 'TEST_INSTALLER2'
    And node 'TEST_NODE2' succeeded to install

    When I run './node list'

    Then the output should include 'ready TEST_NODE1 (installer = TEST_INSTALLER1)'
    And  the output should include 'success TEST_NODE2 (installer = TEST_INSTALLER2)'


  Scenario: node list success (1 enabled node, 1 failed node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE1' is added
    And node 'TEST_NODE2' is added
    And node 'TEST_NODE1' is enabled with installer 'TEST_INSTALLER1'
    And node 'TEST_NODE2' is enabled with installer 'TEST_INSTALLER2'
    And node 'TEST_NODE2' failed to install

    When I run './node list'

    Then the output should include 'ready TEST_NODE1 (installer = TEST_INSTALLER1)'
    And  the output should include 'fail TEST_NODE2 (installer = TEST_INSTALLER2)'


  Scenario: node list success (2 disabled node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE1' is added
    And node 'TEST_NODE2' is added
    And node 'TEST_NODE1' is enabled with installer 'TEST_INSTALLER1'
    And node 'TEST_NODE2' is enabled with installer 'TEST_INSTALLER2'
    And node 'TEST_NODE1' is disabled
    And node 'TEST_NODE2' is disabled

    When I run './node list'

    Then the output should include 'TEST_NODE1 (installer = TEST_INSTALLER1)'
    And  the output should include 'TEST_NODE2 (installer = TEST_INSTALLER2)'


  Scenario: node list success (1 disabled node, 1 installed node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE1' is added
    And node 'TEST_NODE2' is added
    And node 'TEST_NODE1' is enabled with installer 'TEST_INSTALLER1'
    And node 'TEST_NODE2' is enabled with installer 'TEST_INSTALLER2'
    And node 'TEST_NODE1' is disabled
    And node 'TEST_NODE2' succeeded to install

    When I run './node list'

    Then the output should include 'TEST_NODE1 (installer = TEST_INSTALLER1)'
    And  the output should include 'success TEST_NODE2 (installer = TEST_INSTALLER2)'


  Scenario: node list success (1 disabled node, 1 failed node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE1' is added
    And node 'TEST_NODE2' is added
    And node 'TEST_NODE1' is enabled with installer 'TEST_INSTALLER1'
    And node 'TEST_NODE2' is enabled with installer 'TEST_INSTALLER2'
    And node 'TEST_NODE1' is disabled
    And node 'TEST_NODE2' failed to install

    When I run './node list'

    Then the output should include 'TEST_NODE1 (installer = TEST_INSTALLER1)'
    And  the output should include 'fail TEST_NODE2 (installer = TEST_INSTALLER2)'


  Scenario: node list success (2 installed nodes)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE1' is added
    And node 'TEST_NODE2' is added
    And node 'TEST_NODE1' is enabled with installer 'TEST_INSTALLER1'
    And node 'TEST_NODE2' is enabled with installer 'TEST_INSTALLER2'
    And node 'TEST_NODE1' succeeded to install
    And node 'TEST_NODE2' succeeded to install

    When I run './node list'

    Then the output should include 'success TEST_NODE1 (installer = TEST_INSTALLER1)'
    And  the output should include 'success TEST_NODE2 (installer = TEST_INSTALLER2)'


  Scenario: node list success (1 installed node, 1 failed node)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE1' is added
    And node 'TEST_NODE2' is added
    And node 'TEST_NODE1' is enabled with installer 'TEST_INSTALLER1'
    And node 'TEST_NODE2' is enabled with installer 'TEST_INSTALLER2'
    And node 'TEST_NODE1' succeeded to install
    And node 'TEST_NODE2' failed to install

    When I run './node list'

    Then the output should include 'success TEST_NODE1 (installer = TEST_INSTALLER1)'
    And  the output should include 'fail TEST_NODE2 (installer = TEST_INSTALLER2)'


  Scenario: node list success (2 failed nodes)
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE1' is added
    And node 'TEST_NODE2' is added
    And node 'TEST_NODE1' is enabled with installer 'TEST_INSTALLER1'
    And node 'TEST_NODE2' is enabled with installer 'TEST_INSTALLER2'
    And node 'TEST_NODE1' failed to install
    And node 'TEST_NODE2' failed to install

    When I run './node list'

    Then the output should include 'fail TEST_NODE1 (installer = TEST_INSTALLER1)'
    And  the output should include 'fail TEST_NODE2 (installer = TEST_INSTALLER2)'


  #------------------------------------------------------------------------------
  # Misc
  #------------------------------------------------------------------------------


  Scenario: Output of node list is sorted by node name
    Given nodes_directory is '/tmp/nodes'
    And no node is added yet
    And node 'TEST_NODE1' is added
    And node 'TEST_NODE2' is added
    And node 'TEST_NODE3' is added
    And node 'TEST_NODE4' is added
    And node 'TEST_NODE1' is enabled with installer 'TEST_INSTALLER1'
    And node 'TEST_NODE2' is enabled with installer 'TEST_INSTALLER2'
    And node 'TEST_NODE3' is enabled with installer 'TEST_INSTALLER3'
    And node 'TEST_NODE4' is enabled with installer 'TEST_INSTALLER4'
    And node 'TEST_NODE1' failed to install
    And node 'TEST_NODE2' succeeded to install
    And node 'TEST_NODE3' is disabled

    When I run './node list'

    Then line 1 of the output should include 'TEST_NODE1'
    Then line 2 of the output should include 'TEST_NODE2'
    Then line 3 of the output should include 'TEST_NODE3'
    Then line 4 of the output should include 'TEST_NODE4'


  #------------------------------------------------------------------------------
  # [TODO] Test for listing a lot of nodes (~ 10^4 nodes?)
  #------------------------------------------------------------------------------


  Scenario: TEARDOWN
    Then clean up nodes_directory
